<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Map content</title>

    <!-- 합쳐지고 최소화된 최신 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
    <!-- 부가적인 테마 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap-theme.min.css">
    <link rel="stylesheet/less" href="map_less.less">
    <script src="./lib/less.min.js"></script>
</head>

<body>
<!--<nav class="navbar navbar-default navbar-fixed-top">-->
    <!--<div class="container-fluid">-->
        <!--&lt;!&ndash; Brand and toggle get grouped for better mobile display &ndash;&gt;-->
        <!--<div class="navbar-header">-->
            <!--<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">-->
                <!--<span class="sr-only">Toggle navigation</span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
                <!--<span class="icon-bar"></span>-->
            <!--</button>-->
            <!--<a class="navbar-brand" href="#">Brand</a>-->
        <!--</div>-->

        <!--&lt;!&ndash; Collect the nav links, forms, and other content for toggling &ndash;&gt;-->
        <!--<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">-->

            <!--<ul class="nav navbar-nav">-->
                <!--<li><a href="home.html"> Home <span class="sr-only">(current)</span></a></li>-->
                <!--<li class="active"><a href="#">Map</a></li>-->
            <!--</ul>-->
        <!--</div>&lt;!&ndash; /.navbar-collapse &ndash;&gt;-->
    <!--</div>&lt;!&ndash; /.container-fluid &ndash;&gt;-->
<!--</nav>-->
<!--<div class="divider"></div>-->
<div class="backImg"></div>
<div class="pageTitle">
    <p>_ PinTo</p>
</div>

<div class="container" id="mainContainer">
    <nav class="top-nav">
        <div id="homeLink">
            <span class="glyphicon glyphicon-home"><a href="home.html">&nbsp;Home</a></span>
        </div>
        <div id="LogOut">
            <span class="glyphicon glyphicon-fire">&nbsp;LogOut</span>
        </div>
    </nav>
    <div class="row">
        <div class="col-md-8 col-lg-8 col-sm-8">
            <div id="mapDisplayed"></div>

        </div>

        <div class="col-md-4 col-lg-8 col-sm-8" id="thumbnails" :data-images="images">
            <div class="icons">
                <button data-toggle="modal" data-target="#addModal" type="button"><span class="glyphicon glyphicon-plus"></span></button>
                <button type="button"><span class="glyphicon glyphicon-minus" @click="removeAlbum"></span></button>
                <button type="button"><span class="glyphicon glyphicon-th-large" @click="allImagesShowing"></span></button>
            </div>
            <template v-for="content in images">
                <thumbnail :content-Title="content.title" :image-Url="content.representedImage" :total-Contents="content.counter"
                           :total-Images="content.totalImageOfthis" :database-Title="content.dbTitle" :location="content.location"
                           :geo="content.geo" @checked="checkedContentCollect">

                </thumbnail>

            </template>
            <div class="deleteAlbum_buttons">
                <button class="btn btn-warning cancel" @click="cancelAlbum">
                    <i class="glyphicon glyphicon-ban-circle"></i>
                    <span>Cancel</span>
                </button>
                <button class="btn btn-danger delete" @click="deleteAlbum">
                    <i class="glyphicon glyphicon-trash"></i>
                    <span>Delete</span>
                </button>
            </div>
        </div>
    </div>
</div>
<!--Image gallery showing when clicking a image icon @click="showImages"-->
<div id="image-carousel" class="dragdealer">
    <div class="imageCarouselTitle">
        <h1><strong>Pieces of your Journey</strong></h1>
    </div>
    <div class="handle">
        <template v-for="(val, key) in images">
            <gallerythumbnail :image-Url="val" :image-Counter="key"></gallerythumbnail>
        </template>
    </div>
</div>


<div id="addModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-title">
                <h1>Add a Repository</h1>
            </div>
            <div class="modal-body">
                <p>Search Location</p>
                <input v-model='location' id="inputLocationName" type="text" @keyup.enter="fireClick">
                <button type="button" id="SearchBtn">Search</button>
                <div class="searchResultDisplayed">
                    <div id="searchMap">

                    </div>
                </div>
                <p>title</p>
                <input v-model.trim="title" id="inputTitle" type="text">
                <p>Date</p>
                <input type="date" v-model="date" id="inputDate">
                <p>description</p>
                <input v-model="desc" id="inputDesc" type="text">

                <div id="dragndropSection">
                    <div id="previews">
                        <div id="template" class="file-row">

                            <span class="preview"><img data-dz-thumbnail /></span>

                        </div>
                    </div>
                    <p id="afterSaved">
                        <strong>
                            All files is updated to server!
                            escape this window by pressing 'ESC' or clicking outside of this window..
                        </strong>
                    </p>
                    <p id="defaultMsg">
                        <strong>Drag and drop into here!</strong>
                    </p>
                </div>
                <div id="decisionButtons">
                    <button class="btn btn-primary start" @click="start">
                        <i class="glyphicon glyphicon-upload"></i>
                        <span>Start</span>
                    </button>
                    <button data-dz-remove class="btn btn-danger delete" @click="cancel">
                        <i class="glyphicon glyphicon-trash"></i>
                        <span>DeleteAll</span>
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>
<div id="loadingImage_Back">
    <div id="loadingImage">

    </div>
</div>
<div class="container-fluid hidden" id="gridWindow">
    <div class="grid">

    </div>
</div>

<script src="lib/dropzone.js"></script>
<script src="https://unpkg.com/vue"></script>
<script src="lib/dragdealer.js"></script>
<!-- jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<!-- 합쳐지고 최소화된 최신 자바스크립트 -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVwk_iAbB5EqaN02HdCgo4CEKVepMIz7I&libraries=geometry"></script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVwk_iAbB5EqaN02HdCgo4CEKVepMIz7I&libraries=places"></script>
<script src="https://www.gstatic.com/firebasejs/4.2.0/firebase.js"></script>
<script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.js"></script>
<script src="https://unpkg.com/imagesloaded@4/imagesloaded.pkgd.min.js"></script>

<script>
    var init;
    var auth;
    var store;
    var database;

    var map;
    var geocoder;
    var autocomplete;

    var initCenterPoint = new google.maps.LatLng(37.54235, 126.9352);

    var modalMap;
    var centerHeight = window.innerHeight/2;
    var centerWidth = window.innerWidth/2;
    var initialize = function() {
        var deferred = $.Deferred();

        var config = {
            apiKey: "AIzaSyBJiUtsVJoQGr9Mfdci7aTXi8iQVTg9KaU",
            authDomain: "picturemap-1513519046916.firebaseapp.com",
            projectId: "picturemap-1513519046916",
            storageBucket: "picturemap-1513519046916.appspot.com",
            databaseURL: "https://picturemap-1513519046916.firebaseio.com/"
        };

        init = firebase.initializeApp(config);
        auth = init.auth();
        store = init.storage();
        database = init.database();
        if (auth !==null && store !== null && database !== null){

            if (auth.currentUser !== null) {
                var curUser = auth.currentUser;
                var path = store.ref('/user/'+curUser.uid);
            }

            init.auth().onAuthStateChanged(function(user) {
                if (user) {
                    console.log('user persistence is working');
                    deferred.resolve();
                }else {
                    console.log('user is null');
                }
            });

        }

        return deferred.promise()
    };

    initialize().done(function() {
        $.getScript('./src/dropzoneInit.js', function() {
            console.log('dropzone initialization is done');
        }).then(function() {

            map = new google.maps.Map(document.getElementById('mapDisplayed'), {
                center: initCenterPoint,
                zoom: 11
            });

            var startMarker = new google.maps.Marker({
                position: initCenterPoint,
                map: map,
                icon: './img/cutepenguin.gif'
            });
            map.addListener('drag',function() {
                var center = map.getCenter();
                startMarker.setPosition(center);
            });

        });

        var thumbnail_vue = new Vue({
            el: '#thumbnails',
            data: {
                images: [],
                checkedItems: []
            },
            components: {
                thumbnail : {
                    props: ['contentTitle','imageUrl','totalContents','totalImages','databaseTitle','location'
                        ,'geo'],
                    computed: {
                        fullLength: function() {
                            var contents_Num = this.totalContents;
                            var imageWidth = $('.slide>img').width();
                            return contents_Num * imageWidth;
                        }
                    },
                    data : function() {
                        return {
                            checked: []
                        }
                    },
                    template : `<div>
                                    <input class=removeCheck type="checkbox" v-bind:value="databaseTitle" id=":contentTitle" v-model="checked">
                                    <label for=":contentTitle">{{contentTitle}}</label>
                                    <a href="#" class="thumbnail" @click="showImages" @mouseover="moveToLocation">
                                        <img v-bind:src="imageUrl" alt="...">
                                        <span class="badge">+{{totalContents}}</span>
                                    </a>
                                </div>`,
                    watch: {
                        checked: function(val, oldVal) {
                            if (val.length !== 0) {
                                this.$emit('checked', val["0"]);
                            }else {
                                this.$emit('checked', oldVal["0"]);
                            }
                        }
                    },
                    methods: {
                        moveToLocation: function() {
                            map.setCenter({lat: this.geo.lat, lng: this.geo.lng });
                        },
                        showImages: function() {
                            showing_vue.loadingTotalImages(this.totalImages, function() {
                                $('.dragdealer').attr('tabindex', -1).focus();
                                $('.dragdealer').css('display', 'block');
                            });
                        }
                    }
                }
            },
            methods: {
                allImagesShowing : function() {
                    var allImages = [];
                    var locationofDB = database.ref('/'+auth.currentUser.uid+'/allImages');
                    locationofDB.once('value').then(function(snap) {
                        snap.forEach(function(result) {
                            for (var index in result.val()) {
                                allImages.push(result.val()[index]);
                            }
                        })
                    }).then(function(){
                        showing_vue.loadingTotalImages(allImages, function() {
                            $('.dragdealer').attr('tabindex', -1).focus();
                            $('.dragdealer').css('display', 'block');
                        });
                    })
                },
                checkedContentCollect: function(checked) {
                    for (var i=0; i<this.checkedItems.length; i++) {
                        if (this.checkedItems[i] === checked) {
                            this.checkedItems[i] = null;
                            return;
                        }
                    }
                    this.checkedItems.push(checked);
                },
                cancelAlbum: function() {
                    $('.deleteAlbum_buttons').css('display', 'none');
                    $('.removeCheck').css('display', 'none');
                },
                deleteAlbum: function() {
                    var database = init.database();
                    var store = init.storage();
                    var contentTitle = this.checkedItems;

                    for (var title in contentTitle) {
                        if (contentTitle[title] !== null) {
                            database.ref('/'+auth.currentUser.uid+'/'+contentTitle[title]).remove()
                                .then(function() {
                                    console.log('deleted album')
                                    setTimeout(window.location.reload(), 200);
                                })
                            //var storeDelFolder = store.ref('/user/'+auth.currentUser.uid+'/'+contentTitle[title]);
                        }
                    }
                },
                removeAlbum: function() {
                    $('.deleteAlbum_buttons').css('display', 'block');
                    $('.removeCheck').css('display', 'inline');
                },
                imagesLoad : function(callback) {
                    var contentTitle = '';
                    var databaseTitle = '';
                    var location = '';
                    var geo = "";
                    console.log(auth);
                    if (auth.currentUser !== null) {

                        var databaseRef = database.ref('/'+auth.currentUser.uid);
                        databaseRef.once('value').then(function(data){
                            //title
                            data.forEach(function(datasnapshot){
                                console.log(datasnapshot.key);
                                if (datasnapshot.hasChild('downloadURL')) {
                                    databaseTitle = datasnapshot.key;
                                    var resultArray = [];

                                    geo = datasnapshot.child('geometry').val();
                                    contentTitle = datasnapshot.child('title').val();
                                    location = datasnapshot.child('location').val();
                                    datasnapshot.child('downloadURL').forEach(function(urls){
                                        resultArray.push(urls.val());
                                    });
                                    var initMarker = new google.maps.Marker({
                                        clickable: true,
                                        map: map,
                                        position: ({lat:geo.lat, lng:geo.lng}),
                                        animation: google.maps.Animation.DROP,
                                        icon: './img/bluePin.png'
                                    });
                                    var infoContent = '<div>' +
                                        '<p><strong style="font-size:20px; font-family: miseng"><span><img src=""></span>Pinto  ['+location+']</strong></p>' +
                                        '<p><strong>Piece Name : </strong>'+datasnapshot.child('title').val()+'</p>' +
                                        '<p><strong>Detail : </strong>'+datasnapshot.child('desc').val()+'</p>' +
                                        '</div>';
                                    var infoWindow = new google.maps.InfoWindow({
                                        content: infoContent
                                    });

                                    initMarker.addListener('mouseover', function(event){
                                        infoWindow.open(map,initMarker);
                                    });
                                    initMarker.addListener('mouseout', function(event){
                                        infoWindow.close();
                                    });

                                    thumbnail_vue.images.push({
                                        title: contentTitle,
                                        dbTitle: databaseTitle,
                                        representedImage: resultArray[0],
                                        counter: resultArray.length,
                                        totalImageOfthis: resultArray,
                                        location : location,
                                        geo : geo
                                    });
                                }else {
                                    console.log('this is Allimage section, skip');
                                }


                            });
                        }).then(function() {
                            if (typeof callback === 'function'){
                                callback();
                            }
                        })
                    }
                }
            },
            mounted: function() {
                this.imagesLoad(function() {
                    console.log('its done')
                })
            },
        });



        var showing_vue = new Vue({
            el: '#image-carousel',
            data: {
                images: [],
                counter: 0
            },
            components: {
                gallerythumbnail: {
                    props: ['imageUrl', 'imageCounter'],
                    computed: {
                        counterCal: function () {
                            console.log(this.imageUrl);
                            var fixedString = 'img' + this.imageCounter;
                            return fixedString;
                        },
                    },
                    template: `<div class="slide" :class="counterCal"><img :src="imageUrl"></div>`

                }
            },
            methods: {
                loadingTotalImages: function (totalImages, callback) {
                    showing_vue.images = totalImages;

                    var beforePosition = 0;
                    var imagesNum = totalImages.length -1;
                    var xStart = 0;
                    var xMove= 0;
                    var xOffset = 0;
                    var isDragging = false;


                    $('.dragdealer').css('position', 'absolute');

                    $('.dragdealer').on('keyup', function(event) {

                        if (event.which == 27) {
                            $('.dragdealer').css('display', 'none');
                            showing_vue.images = [];
                            $('.handle').css('transform', 'translate3d(0, 0 ,0)');
                            $('.handle').off();
                            $(document).off('mouseup')
                        }
                    });
                    $('.handle').on('mousedown', function (event) {
                        xStart = event.pageX;
                        isDragging = true;
                        console.log('mouse down event');
                    });
                    $('.handle').on('mousemove', function (event) {
                        if (isDragging) {
                            xMove = event.pageX;
                            xOffset = (beforePosition + (xMove - xStart));
                            $('.handle').css('transform', 'translate3d('+xOffset+'px, 0 ,0)');
                        }
                    });
                    $(document).on('mouseup', function (event) {
                        var imageOffset = $('.current')["0"].offsetLeft;
                        var imageSize = $('.current')["0"].offsetWidth;
                        var xEnd = event.pageX;
                        var minMoved = imageSize * 0.5;
                        var distance = xStart - xMove;
                        beforePosition = -imageOffset;
                        if (Math.abs(distance) > minMoved) {
                            if(xStart > xEnd) {
                                xOffset = - imageOffset - imageSize;
                                beforePosition = xOffset;

                                if ($('.current')["0"].nextSibling){
                                    var next = "." + $('.current')["0"].nextSibling.classList["1"];

                                    $('.current').removeClass('current');
                                    $(next).addClass('current');
                                }
                            }else{
                                xOffset = - imageOffset + imageSize;
                                beforePosition = xOffset;

                                if ($('.current')["0"].previousSibling){
                                    var prev = "." + $('.current')["0"].previousSibling.classList["1"];

                                    $('.current').removeClass('current');
                                    $(prev).addClass('current');
                                }
                            }

                        }else {
                            xOffset = - imageOffset
                        }

                        if(xOffset > 0) {
                            xOffset = 0;
                        }else if(xOffset < -(imageSize * imagesNum)) {
                            xOffset = -(imageSize * imagesNum)
                        }

                        $('.handle').css('transform', 'translate3d('+xOffset+'px, 0 ,0)');
                        isDragging = false;
                        console.log('mouse up event');
                    });

                    if (typeof callback === 'function') {
                        callback();
                    }
                },

            },

            updated: function () {
                this.$nextTick(function () {
                    $('.slide:first').addClass('current');
                });
            }
        })


        var modal_vue = new Vue({
            el: '#addModal',
            data: {
                location : "",
                date: "",
                desc: "",
                title: "",
                geometry: ""
            },

            methods: {
                fireClick: function() {
                    document.getElementById('SearchBtn').focus();
                    $('#SearchBtn').trigger('click');
                },
                cancel: function() {
                    myDropzone.removeAllFiles();
                },
                start: function() {
                    var queuedFiles = myDropzone.getQueuedFiles();
                    var currentUserID = auth.currentUser.uid;
                    var location = this.location;
                    var date = this.date;
                    var desc = this.desc;
                    var title = this.title;
                    var geometry = this.geometry;
                    var dbTitle;
                    if (title.search(' ') !== -1) {
                        dbTitle = title.replace(' ', '-');
                    }else {
                        dbTitle = title;
                    }

                    if (currentUserID === null) {
                        alert("please log-in")
                    }else {
                        var pathRoot = store.ref();
                        if (!title) {
                            alert("please input a title to store a conetent into database")
                        }else {
                            $('#decisionButtons>.start').attr('disabled', 'disabled');
                            $('#loadingImage_Back').css('display','block');
                            $('#loadingImage').css({
                                top: centerHeight-200,
                                left: centerWidth-200
                            });
                            var downloadURL = [];
                            var imageStoreProcess = function() {
                                var deferred = $.Deferred();
                                var counter = 0;

                                for (var key in queuedFiles) {
                                    var pathInStore = pathRoot.child('/user/'+currentUserID+'/'+dbTitle+'/'+queuedFiles[key].upload.filename);
                                    pathInStore.put(queuedFiles[key]).then(function(snapshot) {
                                        counter++;
                                        downloadURL.push(snapshot.metadata.downloadURLs[0]);

                                    },function(error){
                                        console.log(error);
                                    }).then(function() {
                                        if (counter === queuedFiles.length){
                                            deferred.resolve();
                                        }
                                    })
                                }

                                return deferred.promise();
                            };
                            imageStoreProcess().then(function() {
                                var inputSet = {
                                    downloadURL: downloadURL,
                                    location : location,
                                    date : date,
                                    desc : desc,
                                    title : title,
                                    geometry: geometry
                                };
                                var databasePath = database.ref('/'+currentUserID+'/'+dbTitle);
                                var duplicationAllImages = database.ref('/'+currentUserID+'/allImages');
                                duplicationAllImages.push().set(downloadURL);
                                databasePath.set(inputSet)
                                    .then(function() {
                                        $('#loadingImage_Back').css('display','none');
                                        $('#afterSaved').css('display', 'block');
                                        console.log('storing into db is successed!');
                                    })

                            })
                        }
                    }
                },
            },

        });
        $('#addModal').on('hidden.bs.modal', function() {
            window.location.reload();
        });
        $('#addModal').on('show.bs.modal', function() {

            $('#SearchBtn').on('click', function() {
                var address = modal_vue.location;
                geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    address: address
                }, function(result, status) {
                    if (status === 'OK') {
                        var marker = new google.maps.Marker({
                            map: modalMap,
                            position: result[0].geometry.location
                        });
                        modal_vue.geometry = {
                            lat :result[0].geometry.location.lat(),
                            lng: result[0].geometry.location.lng()
                        };
                        modalMap.setCenter(result[0].geometry.location);
                    }
                })
            })
        });
        $('#addModal').on('shown.bs.modal', function() {
            modalMap = new google.maps.Map(document.getElementById('searchMap'), {
                center: initCenterPoint,
                zoom: 15
            });
            var circle = new google.maps.Circle({
                center: initCenterPoint,
                radius: 100000
            });
            var option = {
                bounds: circle.getBounds(),
                type: ['(cities)']
            };
            var input = document.getElementById('inputLocationName');
            autocomplete = new google.maps.places.Autocomplete(input, option);
            autocomplete.addListener('place_changed', function() {
                var place = autocomplete.getPlace().formatted_address;
                modal_vue.location = place;
            });
            modalMap.addListener('center_changed', function() {

                var mapCenter = modalMap.getCenter();
                var circleBoundary = new google.maps.Circle({
                    center: mapCenter,
                    radius: 100000
                });
                autocomplete.setBounds(circleBoundary.getBounds());
            });
        });
    });
    $('#LogOut').on('click',function() {
        auth.signOut().then(function() {
            location.href= 'home.html';
        })
    })

</script>

</body>
</html>